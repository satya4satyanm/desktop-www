var GameEngine=function(t,e,a,s){this.FPS=1e3/e,this.canvas=t,this.context2D=t.getContext("2d"),this.gameObjects=[],this.mousePos={x:0,y:0},this.gui=a,this.sm=s,this.coinFall=new CoinFall(t,this.context2D),this.dices=[],this.setupCanvas(),this.totalBet=0,this.dicesStopped=!0,this.throwClicked=!1,this.rands=[],this.initialBal=100,this.bal=this.initialBal,this.bonusGame=!1,this.betCoinValue=5,this.lastBet=[],this.tempLastBet=[],this.tickSound=new sound("assets/audio/tick.mp3"),this.rollingSound=new sound("assets/audio/rolling.mp3"),this.bets=[{val:0,x:105,y:144},{val:0,x:215,y:144},{val:0,x:105,y:234},{val:0,x:215,y:234},{val:0,x:105,y:324},{val:0,x:215,y:324}]};GameEngine.prototype.setupCanvas=function(){this.context2D.textBaseline="top",this.context2D.mouse={x:0,y:0,clicked:!1,down:!1};var t=this;this.canvas.addEventListener("mousemove",function(e){t.context2D.mouse.x=e.offsetX,t.context2D.mouse.y=e.offsetY,t.context2D.mouse.clicked=1==e.which&&!t.context2D.mouse.down,t.context2D.mouse.down=1==e.which,t.mousePos={x:t.context2D.mouse.x,y:t.context2D.mouse.y}}),this.canvas.addEventListener("mousedown",function(e){t.context2D.mouse.clicked=!t.context2D.mouse.down,t.context2D.mouse.down=!0;var a=t.getElementUnderMouse();void 0!==a&&t[a]()}),this.canvas.addEventListener("mouseup",function(e){t.context2D.mouse.down=!1,t.context2D.mouse.clicked=!1})},GameEngine.prototype.startGame=function(){this.sm.setState(this.sm.getState(),"gameplay");for(var t=this.gui,e=t.allGUIEles.others[0],a=t.allGUIEles.others[1],s=t.allGUIEles.others[2],i=t.allGUIEles.others[3],o=t.allGUIEles.others[4],n=t.allGUIEles.others[5],h=0;h<1;h++)for(var l=0;l<3;l++){var d=new Dice(18,3,!0,e,a,s,i,o,n,412.5+70*l,160+100*h,this.context2D);this.dices.push(d)}},GameEngine.prototype.reStartGame=function(){this.bal=this.initialBal,this.dices=[],this.startGame()},GameEngine.prototype.throwDices=function(){var t=this;if(t.totalBet>0&&t.dicesStopped&&!t.bonusGame){t.rollingSound.play();var e={x:0,y:4.71,z:4.71},a={x:4.71,y:0,z:4.71},s={x:0,y:0,z:1.57},i={x:1.57,y:0,z:0},o={x:0,y:3.14,z:0},n={x:0,y:1.57,z:3.14};t.throwClicked=!0,t.bonusGame||(t.lastBet=t.tempLastBet,t.tempLastBet=[]),t.dices.forEach(function(h){var l=Math.ceil(6*Math.random());h.rand=l,1==l&&(h.tempRot=e),2==l&&(h.tempRot=a),3==l&&(h.tempRot=s),4==l&&(h.tempRot=i),5==l&&(h.tempRot=o),6==l&&(h.tempRot=n),h.rotations={x:h.tempRot.x-28,y:h.tempRot.y-28,z:h.tempRot.z-28},h.rotEnabled=!0,h.animate(),t.rands.push(l-1)})}},GameEngine.prototype.draw=function(){this.context2D.beginPath(),this.context2D.fillStyle="#000000",this.context2D.shadowOffsetX=0,this.context2D.shadowOffsetY=0,this.context2D.shadowBlur=1,this.context2D.shadowColor="rgba(0, 0, 0, 0.05)",this.context2D.save(),this.createGUI()},GameEngine.prototype.createGUI=function(){for(var t=this.mousePos,e=this.gui,a=this.sm.getState(),s=e.allGUIEles[a],i=0;i<s.length;++i){var o=s[i],n=o.data_px,h=o.data_px+o.data_fw,l=o.data_py,d=o.data_py+o.data_fh;o.data_btn&&!o.data_popup?!this.bonusGame&&this.dicesStopped&&t.x>n&&t.x<h&&t.y>l&&t.y<d?this.context2D.drawImage(o,o.data_fx,o.data_fy+o.data_fh,o.data_fw,o.data_fh,o.data_px-5,o.data_py-5,o.data_sw,o.data_sh):this.context2D.drawImage(o,o.data_fx,o.data_fy,o.data_fw,o.data_fh,o.data_px,o.data_py,o.data_sw-10,o.data_sh-10):this.context2D.drawImage(o,o.data_fx,o.data_fy,o.data_fw,o.data_fh,o.data_px,o.data_py,o.data_sw,o.data_sh)}if("gameplay"==a){this.context2D.beginPath(),this.context2D.font="11pt Kremlin Pro Web",this.context2D.fillStyle="#ffffff",this.context2D.fillText(this.bal,564,50),this.boardPositions=[];for(i=0;i<3;i++)for(var u=0;u<2;u++)this.boardPositions.push({data_btn:!0,data_x:110*u+86,data_y:92*i+122,data_w:100,data_h:80,data_name:"p"+i+"_"+u,data_cb:"addBetOn"+i+"_"+u});if(this.totalBet>0)for(var b=0;b<6;b++)this.bets[b].val>0&&this.context2D.drawImage(e.c5,this.bets[b].x,this.bets[b].y,35,35);this.bonusGame&&(this.context2D.drawImage(this.gui.bonusimg,0,0),this.coinFall.drawloop());var c=this;this.dices.forEach(function(t){t.rotEnabled?(t.animate(),c.dicesStopped=!1):(t.updateFrameFunc(),c.dicesStopped=!0,c.totalBet>0&&c.throwClicked&&(c.throwClicked=!1,c.doPayout()))})}},GameEngine.prototype.showPaytable=function(){this.sm.setState(this.sm.getState(),"payTable")},GameEngine.prototype.doPayout=function(){if(this.totalBet>0){var t={c:0,b:!1},e={c:0,b:!1};this.bets[1].val>0&&(t.b=!0),this.bets[2].val>0&&(e.b=!0);for(var a=0;a<3;++a)2==this.dices[a].rand?t.c++:3==this.dices[a].rand&&e.c++;for(var s=0,i=0;i<6;++i){var o=!1;for(a=0;a<3;++a)i+1==this.dices[a].rand&&this.bets[i].val>0&&(o=!0,s+=this.betCoinValue);this.bets[i].val>0&&o&&(s+=this.betCoinValue,this.bets[i].val=0)}s>0&&(this.bal+=s);for(i=0;i<6;++i)this.bets[i].val=0;t.b&&t.c>=2?(this.bets[1].val=this.betCoinValue,this.totalBet=this.betCoinValue,this.bonusGame=!0,t.b=!1,t.c=0):e.b&&3===e.c?(this.bets[2].val=this.betCoinValue,this.totalBet=this.betCoinValue,this.bonusGame=!0,e.b=!1,e.c=0):(this.totalBet=0,this.bonusGame=!1)}0==this.bal&&this.sm.setState(this.sm.getState(),"finalScreen")},GameEngine.prototype.playBonus=function(){this.bonusGame=!1,this.throwDices()},GameEngine.prototype.clearBet=function(){if(this.dicesStopped){this.tickSound.play();for(var t=0;t<this.bets.length;++t)this.bets[t].val>0&&(this.bets[t].val=0,this.totalBet-=this.betCoinValue,this.bal+=this.betCoinValue);this.tempLastBet=[]}},GameEngine.prototype.rebet=function(){if(this.dicesStopped&&0===this.tempLastBet.length&&this.lastBet.length*this.betCoinValue<=this.bal){this.tickSound.play();for(var t=0;t<this.lastBet.length;++t)this.bets[this.lastBet[t]].val+=this.betCoinValue,this.totalBet+=this.betCoinValue,this.bal-=this.betCoinValue,this.tempLastBet.push(this.lastBet[t])}},GameEngine.prototype.addBetOn0_0=function(){this.bets[0].val<this.betCoinValue&&this.bal>=this.betCoinValue&&(this.tickSound.play(),this.bets[0].val+=this.betCoinValue,this.totalBet+=this.betCoinValue,this.bal-=this.betCoinValue,this.tempLastBet.push(0))},GameEngine.prototype.addBetOn0_1=function(){this.bets[1].val<this.betCoinValue&&this.bal>=this.betCoinValue&&(this.tickSound.play(),this.bets[1].val+=this.betCoinValue,this.totalBet+=this.betCoinValue,this.bal-=this.betCoinValue,this.tempLastBet.push(1))},GameEngine.prototype.addBetOn1_0=function(){this.bets[2].val<this.betCoinValue&&this.bal>=this.betCoinValue&&(this.tickSound.play(),this.bets[2].val+=this.betCoinValue,this.totalBet+=this.betCoinValue,this.bal-=this.betCoinValue,this.tempLastBet.push(2))},GameEngine.prototype.addBetOn1_1=function(){this.bets[3].val<this.betCoinValue&&this.bal>=this.betCoinValue&&(this.tickSound.play(),this.bets[3].val+=this.betCoinValue,this.totalBet+=this.betCoinValue,this.bal-=this.betCoinValue,this.tempLastBet.push(3))},GameEngine.prototype.addBetOn2_0=function(){this.bets[4].val<this.betCoinValue&&this.bal>=this.betCoinValue&&(this.tickSound.play(),this.bets[4].val+=this.betCoinValue,this.totalBet+=this.betCoinValue,this.bal-=this.betCoinValue,this.tempLastBet.push(4))},GameEngine.prototype.addBetOn2_1=function(){this.bets[5].val<this.betCoinValue&&this.bal>=this.betCoinValue&&(this.tickSound.play(),this.bets[5].val+=this.betCoinValue,this.totalBet+=this.betCoinValue,this.bal-=this.betCoinValue,this.tempLastBet.push(5))},GameEngine.prototype.getElementUnderMouse=function(){for(var t=this.gui,e=this.mousePos,a=this.sm.getState(),s=t.allGUIEles[a],i=0;i<s.length;++i){var o=(b=s[i]).data_px,n=b.data_px+b.data_fw-10,h=b.data_py,l=b.data_py+b.data_fh-10;if(b.data_btn&&e.x>o&&e.x<n&&e.y>h&&e.y<l)return b.data_cb}if("gameplay"==a&&this.dicesStopped)for(var d=this.boardPositions.length,u=0;u<d;++u){var b;o=(b=this.boardPositions[u]).data_x,n=b.data_x+b.data_w-10,h=b.data_y,l=b.data_y+b.data_h-10;if(b.data_btn&&e.x>o&&e.x<n&&e.y>h&&e.y<l)return b.data_cb}if(this.bonusGame)return this.gui.bonusimg.data_cb};